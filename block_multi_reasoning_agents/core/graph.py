import json
from typing import Any, Dict, Optional, Sequence
from langchain_core.messages import BaseMessage, AIMessage
from langgraph.graph import Graph, StateGraph, END
from pydantic import BaseModel, Field
import streamlit as st

from agents.plan_agent import PlanningAgent
from agents.vision_agent import VisionAgent
from core.display import display_state_details
from utils.logger import setup_logger

logger = setup_logger(__name__)

# ÂàùÂßãÂåñagents
vision_agent = VisionAgent()
planning_agent = PlanningAgent()


class AgentState(BaseModel):
    """Á≥ªÁªüÁä∂ÊÄÅÂÆö‰πâ"""

    block_img_path: str
    block_frame_img_path: str
    task_description: str
    messages: Sequence[BaseMessage] = Field(default_factory=list)
    blocks_data: Optional[Dict] = Field(default_factory=dict)
    planned_solution: Optional[Dict] = Field(default_factory=dict)
    state_containers: Optional[Dict] = None  # Ê∑ªÂä†Áä∂ÊÄÅÂÆπÂô®Â≠óÊÆµ
    final_solutions: Optional[str] = None  # Ê∑ªÂä†ÊúÄÁªàËß£ÂÜ≥ÊñπÊ°àÂ≠óÊÆµ


def vision_node(state: AgentState) -> AgentState:
    """Vision Agent ËäÇÁÇπÂ§ÑÁêÜÂáΩÊï∞"""
    try:
        vision_container = state.state_containers.get("vision")
        if vision_container:
            with vision_container:
                st.write("üîç Performing Image Analysis... ")

                # state.blocks_data = {
                #     "total_blocks": 19,
                #     "blocks": [
                #         {
                #             "id": 1,
                #             "layout": "horizontal",
                #             "length": 3,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"},
                #                 {"type": "square", "position": 2, "orientation": "up"},
                #                 {
                #                     "type": "triangle",
                #                     "position": 3,
                #                     "orientation": "left",
                #                 },
                #             ],
                #         },
                #         {
                #             "id": 2,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"},
                #                 {"type": "square", "position": 2, "orientation": "up"},
                #             ],
                #         },
                #         {
                #             "id": 3,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"},
                #                 {
                #                     "type": "triangle",
                #                     "position": 2,
                #                     "orientation": "left",
                #                 },
                #             ],
                #         },
                #         {
                #             "id": 4,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"},
                #                 {"type": "circle", "position": 2, "orientation": "up"},
                #             ],
                #         },
                #         {
                #             "id": 5,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {
                #                     "type": "triangle",
                #                     "position": 1,
                #                     "orientation": "up",
                #                 },
                #                 {
                #                     "type": "triangle",
                #                     "position": 2,
                #                     "orientation": "up",
                #                 },
                #             ],
                #         },
                #         {
                #             "id": 6,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {
                #                     "type": "triangle",
                #                     "position": 1,
                #                     "orientation": "left",
                #                 },
                #                 {"type": "circle", "position": 2, "orientation": "up"},
                #             ],
                #         },
                #         {
                #             "id": 7,
                #             "layout": "horizontal",
                #             "length": 2,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"},
                #                 {"type": "circle", "position": 2, "orientation": "up"},
                #             ],
                #         },
                #         {
                #             "id": 8,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 9,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 10,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 11,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "square", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 12,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "triangle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 13,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "triangle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 14,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "triangle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 15,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "triangle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 16,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 17,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 18,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #         {
                #             "id": 19,
                #             "layout": "single",
                #             "length": 1,
                #             "shapes": [
                #                 {"type": "circle", "position": 1, "orientation": "up"}
                #             ],
                #         },
                #     ],
                #     "frame": {
                #         "total_shapes": 9,
                #         "shapes": [
                #             {"type": "circle", "position": "a", "orientation": "up"},
                #             {"type": "circle", "position": "b", "orientation": "up"},
                #             {"type": "square", "position": "c", "orientation": "up"},
                #             {"type": "circle", "position": "d", "orientation": "up"},
                #             {"type": "square", "position": "e", "orientation": "up"},
                #             {"type": "square", "position": "f", "orientation": "up"},
                #             {"type": "triangle", "position": "g", "orientation": "up"},
                #             {"type": "triangle", "position": "h", "orientation": "up"},
                #             {"type": "triangle", "position": "i", "orientation": "up"},
                #         ],
                #     },
                # }
                # Ë∞ÉÁî®Vision AgentÂ§ÑÁêÜÂõæÁâá
                result = vision_agent.invoke(
                    {
                        "name": "vision_agent",
                        "args": {
                            "block_img_path": state.block_img_path,
                            "block_frame_img_path": state.block_frame_img_path,
                        },
                        "id": "vision_analysis",
                        "type": "tool_call",
                    }
                )
                data = json.loads(result.content)
                # Áõ¥Êé•‰ΩøÁî®ËøîÂõûÁöÑÂ≠óÂÖ∏ÁªìÊûú
                if isinstance(data, dict) and data.get("status") == "success":
                    analysis = data.get("analysis", {})

                    # Ëé∑ÂèñÁßØÊú®ÂíåÊ°ÜÊû∂ÁöÑÂàÜÊûêÁªìÊûú
                    blocks_analysis = analysis.get("blocks", {})
                    frame_analysis = analysis.get("frame", {})

                    # ÂêàÂπ∂Êï∞ÊçÆ
                    if blocks_analysis.get("success") and frame_analysis.get("success"):
                        blocks_data = blocks_analysis.get("data", {})
                        frame_data = frame_analysis.get("data", {})

                        state.blocks_data = {
                            "total_blocks": blocks_data.get("total_blocks", 0),
                            "blocks": blocks_data.get("blocks", []),
                            "frame": frame_data
                        }

                        # Ê∑ªÂä†ÂàÜÊûêÁªìÊûúÊèèËø∞
                        state.messages = list(state.messages) + [
                            AIMessage(content=blocks_analysis.get("content", "")),
                            AIMessage(content=frame_analysis.get("content", "")),
                        ]
                    else:
                        error_msg = "ÂõæÁâáÂàÜÊûêÈÉ®ÂàÜÂ§±Ë¥•"
                        if not blocks_analysis.get("success"):
                            error_msg += " - ÁßØÊú®ÂàÜÊûêÂ§±Ë¥•"
                        if not frame_analysis.get("success"):
                            error_msg += " - Ê°ÜÊû∂ÂàÜÊûêÂ§±Ë¥•"
                        state.blocks_data = {"error": error_msg}
                        state.messages = list(state.messages) + [AIMessage(content=error_msg)]
                else:
                    error_msg = "ËßÜËßâÂàÜÊûêÂ§±Ë¥•ÊàñËøîÂõûÊ†ºÂºè‰∏çÊ≠£Á°Æ"
                    state.blocks_data = {"error": error_msg}
                    state.messages = list(state.messages) + [AIMessage(content=error_msg)]

                logger.info("======== Vision Agent result =========")
                logger.info(f"{state.blocks_data}")

                display_state_details(state.blocks_data, "blocks_data")

                return state

    except Exception as e:
        logger.error(f"Error in vision node: {str(e)}")
        error_msg = f"Vision AgentÊâßË°åÂá∫Èîô: {str(e)}"
        state.blocks_data = {"error": error_msg}
        state.messages = list(state.messages) + [AIMessage(content=error_msg)]
        if vision_container:
            with vision_container:
                st.error(f"VisionÂàÜÊûêÂ§±Ë¥•: {str(e)}")
        return state


def planning_node(state: AgentState) -> AgentState:
    """Planning Agent ËäÇÁÇπÂ§ÑÁêÜÂáΩÊï∞"""
    try:
        planning_container = state.state_containers.get("planning")
        if planning_container:
            with planning_container:
                st.write("üéØ Task Planning in Progress...")

                # Ê£ÄÊü•ÊòØÂê¶ÊúâÁßØÊú®Êï∞ÊçÆ
                if "error" in state.blocks_data:
                    state.planned_solution = {"error": state.blocks_data.get("error")}
                    display_state_details(state.planned_solution, "planned_solution")

                    return state

                result = planning_agent.plan(
                    planning_container, state.blocks_data, state.task_description
                )

                state.planned_solution = result

                # Ê†ºÂºèÂåñËß£ÂÜ≥ÊñπÊ°àÊ∂àÊÅØ
                solutions = result.get("solutions", [])
                solution_text = "===== The task planning result is as follows: =====\n\n"

                for idx, solution in enumerate(solutions, 1):
                    solution_text += f"„ÄêTarget peg number {idx}„ÄëÔºö\n\n"
                    for j, block in enumerate(solution.get("blocks", []), 1):
                        # ‰∏∫ÊØè‰∏™ÁßØÊú®ÂàõÂª∫Â∏¶‰ΩçÁΩÆ‰ø°ÊÅØÁöÑÊèèËø∞
                        block_id = str(block["block_id"])
                        positions = block["positions"]
                        # Ê∑ªÂä†Âà∞ÊñáÊú¨‰∏≠
                        solution_text += f"({block_id}, <{' '.join(positions)}>)\n\n"

                    solution_text += "\n"
                    state.final_solutions = solution_text

                # Â¶ÇÊûúÊ≤°ÊúâËß£ÂÜ≥ÊñπÊ°àÔºåÊ∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØ
                if not solutions:
                    state.final_solutions = "Êú™ÊâæÂà∞ÊúâÊïàÁöÑËß£ÂÜ≥ÊñπÊ°à"

                display_state_details(state.planned_solution, "planned_solution")

                return state

    except Exception as e:
        logger.error(f"Error in planning node: {str(e)}")
        error_msg = f"Planning AgentÊâßË°åÂá∫Èîô: {str(e)}"
        state.planned_solution = {"error": error_msg}
        state.messages = list(state.messages) + [AIMessage(content=error_msg)]
        if planning_container:
            with planning_container:
                st.error(f"‰ªªÂä°ËßÑÂàíÂ§±Ë¥•: {str(e)}")
        return state


def create_agent_graph() -> Graph:
    """ÂàõÂª∫Êô∫ËÉΩ‰ΩìÂ∑•‰ΩúÊµÅÂõæ"""
    # ÂàõÂª∫Â∑•‰ΩúÊµÅ
    workflow = StateGraph(AgentState)

    # Ê∑ªÂä†ËäÇÁÇπ
    workflow.add_node("vision", vision_node)
    workflow.add_node("planning", planning_node)

    # Ê∑ªÂä†ËæπÂíåÊù°‰ª∂
    workflow.set_entry_point("vision")
    workflow.add_edge("vision", "planning")
    workflow.add_edge("planning", END)

    # ÁºñËØëÂ∑•‰ΩúÊµÅ
    return workflow.compile()
